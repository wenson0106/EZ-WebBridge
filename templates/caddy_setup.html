{% extends "base.html" %}
{% block title %}Caddy è¨­å®š â€” EZ-WebBridge{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-card">
        <!-- Step indicator -->
        <div class="wizard-steps">
            <div class="wizard-step active" data-step="1">
                <div class="wizard-step-dot">1</div>
                <span>ä¸‹è¼‰ Caddy</span>
            </div>
            <div class="wizard-step-line"></div>
            <div class="wizard-step" data-step="2">
                <div class="wizard-step-dot">2</div>
                <span>æ–°å¢æœå‹™</span>
            </div>
            <div class="wizard-step-line"></div>
            <div class="wizard-step" data-step="3">
                <div class="wizard-step-dot">3</div>
                <span>å•Ÿå‹•å®Œæˆ</span>
            </div>
        </div>

        <!-- Step 1: Download Caddy -->
        <div class="wizard-panel active" id="step-1">
            <div class="wizard-panel-icon" data-icon="download"></div>
            <h2 class="wizard-panel-title">ä¸‹è¼‰ Caddy ä¼ºæœå™¨</h2>

            <div class="wizard-tutorial" style="background:#f0f9ff; border-color:#bae6fd;">
                <div class="wizard-tutorial-steps" style="color:#0c4a6e; padding:12px 16px;">
                    <strong>â„¹ï¸ Caddy æ¨¡å¼èªªæ˜ï¼š</strong>
                    <ul style="margin:8px 0 0 20px; list-style:disc;">
                        <li>æ‚¨éœ€è¦æœ‰<strong>å›ºå®š IP</strong> ä»¥åŠåœ¨è·¯ç”±å™¨ä¸Šé–‹æ”¾ Port 80 å’Œ 443ã€‚</li>
                        <li>Caddy æœƒè‡ªå‹•å‘ <strong>Let's Encrypt</strong> ç”³è«‹å…è²» SSL æ†‘è­‰ã€‚</li>
                        <li>æ‚¨å¯ä»¥ç›´æ¥è½‰ç™¼è‡³å€ç¶²å…§çš„å…¶ä»–è¨­å‚™ (ä¾‹å¦‚ 192.168.1.x)ã€‚</li>
                    </ul>
                </div>
            </div>

            <p class="wizard-panel-text">
                Caddy æ˜¯ä¸€å€‹è¼•é‡ã€é«˜æ•ˆçš„ç¶²é ä¼ºæœå™¨ï¼Œæ”¯æ´è‡ªå‹• HTTPSã€‚é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ä¸‹è¼‰ã€‚
            </p>
            <div id="download-status" class="wizard-status">
                <div class="wizard-status-icon" data-icon="info"></div>
                <span>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ä¸‹è¼‰</span>
            </div>
            <div class="wizard-progress" id="download-progress" style="display:none;">
                <div class="wizard-progress-bar" id="download-bar"></div>
            </div>
            <div class="wizard-actions">
                <button class="btn btn-secondary" onclick="window.location.href='/triage'">
                    <span data-icon="arrowLeft"></span>è¿”å›
                </button>
                <button class="btn btn-primary" id="download-btn" onclick="downloadCaddy()">
                    <span data-icon="download"></span>ä¸‹è¼‰ Caddy
                </button>
            </div>
        </div>

        <!-- Step 2: Add services -->
        <div class="wizard-panel" id="step-2">
            <div class="wizard-panel-icon" data-icon="server"></div>
            <h2 class="wizard-panel-title">æ–°å¢è¦å…¬é–‹çš„æœå‹™</h2>
            <p class="wizard-panel-text">
                å¡«å¯«è¦å…¬é–‹çš„<strong>ç¶²åŸŸåç¨±</strong>å’Œ<strong>å…§ç¶²ç›®æ¨™ä½å€</strong>ã€‚å¯ä»¥æ–°å¢å¤šå€‹æœå‹™ã€‚
            </p>

            <div id="services-list" class="services-editor"></div>

            <button class="btn btn-secondary" onclick="addServiceRow()" id="add-service-btn"
                style="width:100%; margin-bottom:16px;">
                <span data-icon="plus"></span>æ–°å¢æœå‹™
            </button>

            <div class="wizard-actions">
                <button class="btn btn-secondary" onclick="goToStep(1)">
                    <span data-icon="arrowLeft"></span>ä¸Šä¸€æ­¥
                </button>
                <button class="btn btn-primary" id="setup-btn" onclick="submitSetup()">
                    <span data-icon="zap"></span>å•Ÿå‹• Caddy
                </button>
            </div>
        </div>

        <!-- Step 3: Done -->
        <div class="wizard-panel" id="step-3">
            <div class="wizard-panel-icon success" data-icon="check"></div>
            <h2 class="wizard-panel-title">ğŸ‰ å•Ÿå‹•æˆåŠŸï¼</h2>
            <p class="wizard-panel-text">
                Caddy å·²æˆåŠŸå•Ÿå‹•ã€‚<br>
                è«‹ç¢ºèªæ‚¨çš„è·¯ç”±å™¨å·²å°‡ Port 80 å’Œ 443 è½‰ç™¼åˆ°é€™å°é›»è…¦ã€‚
            </p>
            <div class="wizard-actions" style="justify-content:center;">
                <button class="btn btn-primary" onclick="window.location.href='/caddy/dashboard'">
                    <span data-icon="arrowRight"></span>å‰å¾€å„€è¡¨æ¿
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let serviceCount = 0;

    function goToStep(step) {
        document.querySelectorAll('.wizard-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active', 'done'));
        document.getElementById(`step-${step}`).classList.add('active');
        for (let i = 1; i <= 3; i++) {
            const el = document.querySelector(`.wizard-step[data-step="${i}"]`);
            if (i < step) el.classList.add('done');
            else if (i === step) el.classList.add('active');
        }
    }

    async function downloadCaddy() {
        const btn = document.getElementById('download-btn');
        const status = document.getElementById('download-status');
        const progress = document.getElementById('download-progress');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span> ä¸‹è¼‰ä¸­â€¦`;
        status.innerHTML = `<div class="wizard-status-icon">${icon('info')}</div><span>æ­£åœ¨ä¸‹è¼‰ Caddyï¼Œè«‹ç¨å€™â€¦</span>`;
        status.className = 'wizard-status info';
        progress.style.display = 'block';
        try {
            const resp = await fetch('/api/caddy/install-binary', { method: 'POST' });
            const data = await resp.json();
            if (data.success) {
                status.innerHTML = `<div class="wizard-status-icon">${icon('check')}</div><span>ä¸‹è¼‰å®Œæˆï¼</span>`;
                status.className = 'wizard-status success';
                document.getElementById('download-bar').style.width = '100%';
                setTimeout(() => { goToStep(2); addServiceRow(); }, 800);
            } else {
                status.innerHTML = `<div class="wizard-status-icon">${icon('alertCircle')}</div><span>${escapeHtml(data.message)}</span>`;
                status.className = 'wizard-status error';
                btn.disabled = false;
                btn.innerHTML = `${icon('download')} é‡è©¦ä¸‹è¼‰`;
            }
        } catch (e) {
            status.innerHTML = `<div class="wizard-status-icon">${icon('alertCircle')}</div><span>ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦</span>`;
            status.className = 'wizard-status error';
            btn.disabled = false;
            btn.innerHTML = `${icon('download')} é‡è©¦ä¸‹è¼‰`;
        }
    }

    function addServiceRow(domain = '', target = '') {
        const id = ++serviceCount;
        const list = document.getElementById('services-list');
        const row = document.createElement('div');
        row.className = 'service-editor-row';
        row.id = `svc-row-${id}`;
        row.innerHTML = `
            <div class="service-editor-fields">
                <div class="form-group" style="flex:1;">
                    <label class="form-label">ç¶²åŸŸ (Public Domain)</label>
                    <input class="form-input" type="text" id="svc-domain-${id}" value="${escapeHtml(domain)}"
                        placeholder="app.example.com">
                </div>
                <div class="form-group" style="flex:1;">
                    <label class="form-label">ç›®æ¨™ä½å€ (Target)</label>
                    <input class="form-input" type="text" id="svc-target-${id}" value="${escapeHtml(target)}"
                        placeholder="localhost:3000 æˆ– 192.168.1.50:8080">
                </div>
                <button class="btn btn-danger btn-sm" onclick="document.getElementById('svc-row-${id}').remove()" style="align-self:flex-end;">
                    ${icon('trash')}
                </button>
            </div>
        `;
        list.appendChild(row);
        renderIcons();
        row.querySelectorAll('[data-icon]').forEach(el => {
            const name = el.getAttribute('data-icon');
            if (Icons[name]) el.innerHTML = Icons[name];
        });
    }

    function collectServices() {
        const services = [];
        const rows = document.querySelectorAll('.service-editor-row');
        rows.forEach(row => {
            const id = row.id.replace('svc-row-', '');
            const domain = document.getElementById(`svc-domain-${id}`)?.value.trim();
            const target = document.getElementById(`svc-target-${id}`)?.value.trim();
            if (domain && target) services.push({ domain, target });
        });
        return services;
    }

    async function submitSetup() {
        const services = collectServices();
        if (!services.length) { showToast('è«‹è‡³å°‘æ–°å¢ä¸€å€‹æœå‹™', 'error'); return; }
        const btn = document.getElementById('setup-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span> å•Ÿå‹•ä¸­â€¦`;
        try {
            const resp = await fetch('/api/caddy/setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ services }),
            });
            const data = await resp.json();
            if (data.success) {
                showToast('Caddy å•Ÿå‹•æˆåŠŸï¼', 'success');
                goToStep(3);
            } else {
                showToast(data.message || 'å•Ÿå‹•å¤±æ•—', 'error');
                btn.disabled = false;
                btn.innerHTML = `${icon('zap')} å•Ÿå‹• Caddy`;
            }
        } catch (e) {
            showToast('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦', 'error');
            btn.disabled = false;
            btn.innerHTML = `${icon('zap')} å•Ÿå‹• Caddy`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderIcons();
        fetch('/api/caddy/status').then(r => r.json()).then(data => {
            if (data.installed) {
                const status = document.getElementById('download-status');
                status.innerHTML = `<div class="wizard-status-icon">${icon('check')}</div><span>Caddy å·²å®‰è£</span>`;
                status.className = 'wizard-status success';
                const btn = document.getElementById('download-btn');
                btn.textContent = 'å·²å®‰è£ â€” ä¸‹ä¸€æ­¥';
                btn.onclick = () => { goToStep(2); addServiceRow(); };
                if (data.config?.services?.length) {
                    // Pre-populate existing services on revisit
                    goToStep(2);
                    data.config.services.forEach(s => addServiceRow(s.domain, s.target));
                }
            }
        });
    });
</script>

<style>
    .services-editor {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 12px;
    }

    .service-editor-row {
        background: var(--color-surface-alt);
        border: 1px solid var(--color-border);
        border-radius: 10px;
        padding: 14px;
    }

    .service-editor-fields {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        flex-wrap: wrap;
    }

    .btn-danger {
        background: #fee2e2;
        color: #dc2626;
        border: none;
    }

    .btn-danger:hover {
        background: #fca5a5;
    }

    .btn-sm {
        padding: 6px 10px;
        font-size: 13px;
    }
</style>
{% endblock %}