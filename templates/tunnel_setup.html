{% extends "base.html" %}
{% block title %}Tunnel è¨­å®š â€” EZ-WebBridge{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-card">
        <!-- Step indicator -->
        <div class="wizard-steps">
            <div class="wizard-step active" data-step="1">
                <div class="wizard-step-dot">1</div>
                <span>å®‰è£å·¥å…·</span>
            </div>
            <div class="wizard-step-line"></div>
            <div class="wizard-step" data-step="2">
                <div class="wizard-step-dot">2</div>
                <span>è¼¸å…¥ Token</span>
            </div>
            <div class="wizard-step-line"></div>
            <div class="wizard-step" data-step="3">
                <div class="wizard-step-dot">3</div>
                <span>è¨­å®šå®Œæˆ</span>
            </div>
        </div>

        <!-- Step 1: Download cloudflared -->
        <div class="wizard-panel active" id="step-1">
            <div class="wizard-panel-icon" data-icon="download"></div>
            <h2 class="wizard-panel-title">å®‰è£ Cloudflare Tunnel å·¥å…·</h2>

            <div class="wizard-tutorial" style="background:#fff8e6; border-color:#ffeeba;">
                <div class="wizard-tutorial-steps" style="color:#856404; padding: 12px 16px;">
                    <strong>âš ï¸äº‹å‰æº–å‚™ï¼š</strong> æœ¬åŠŸèƒ½éœ€è¦æ‚¨æ“æœ‰ä¸€å€‹ç¶²åŸŸï¼ˆDomainï¼‰ï¼Œä¸” DNS éœ€è¨—ç®¡åœ¨ Cloudflare ä¸Šã€‚
                    <ul style="margin: 8px 0 0 20px; list-style: disc;">
                        <li>æ²’æœ‰ç¶²åŸŸï¼Ÿæ¨è–¦è‡³ <a href="https://www.namecheap.com/" target="_blank">Namecheap</a> æˆ– <a
                                href="https://tw.godaddy.com/" target="_blank">GoDaddy</a> è³¼è²·ã€‚</li>
                        <li>æœ‰ç¶²åŸŸä½†æœªé€£çµ Cloudflareï¼Ÿè«‹åƒè€ƒ <a
                                href="https://developers.cloudflare.com/dns/zone-setups/full-setup/setup/"
                                target="_blank">å®˜æ–¹æ•™å­¸</a>ã€‚</li>
                    </ul>
                </div>
            </div>

            <p class="wizard-panel-text">
                æˆ‘å€‘éœ€è¦å…ˆä¸‹è¼‰ <code>cloudflared</code> å·¥å…·ã€‚é€™æ˜¯ Cloudflare å®˜æ–¹æä¾›çš„å…è²»ç¨‹å¼ï¼Œè² è²¬å»ºç«‹å®‰å…¨é€£ç·šã€‚
            </p>
            <div id="download-status" class="wizard-status">
                <div class="wizard-status-icon" data-icon="info"></div>
                <span>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ä¸‹è¼‰</span>
            </div>
            <div class="wizard-progress" id="download-progress" style="display:none;">
                <div class="wizard-progress-bar" id="download-bar"></div>
            </div>
            <div class="wizard-actions">
                <button class="btn btn-secondary" onclick="window.location.href='/triage'">
                    <span data-icon="arrowLeft"></span>
                    è¿”å›
                </button>
                <button class="btn btn-primary" id="download-btn" onclick="downloadCloudflared()">
                    <span data-icon="download"></span>
                    ä¸‹è¼‰ cloudflared
                </button>
            </div>
        </div>

        <!-- Step 2: Token input -->
        <div class="wizard-panel" id="step-2">
            <div class="wizard-panel-icon" data-icon="key"></div>
            <h2 class="wizard-panel-title">è¼¸å…¥ Cloudflare Tunnel Token</h2>
            <p class="wizard-panel-text">
                æ‚¨éœ€è¦å¾ Cloudflare å–å¾—ä¸€çµ„ Tunnel Tokenã€‚é€™æ˜¯ä¸€æ®µä»¥ <code>eyJ</code> é–‹é ­çš„é•·å­—ä¸²ã€‚
            </p>

            <div class="wizard-tutorial">
                <div class="wizard-tutorial-header" onclick="toggleTutorial()">
                    <span data-icon="helpCircle"></span>
                    <span>å¦‚ä½•å–å¾— Tokenï¼Ÿï¼ˆé»æ“Šå±•é–‹æ•™å­¸ï¼‰</span>
                    <span data-icon="chevronRight" class="tutorial-chevron"></span>
                </div>
                <div class="wizard-tutorial-body" id="tutorial-body">
                    <ol class="wizard-tutorial-steps">
                        <li>å‰å¾€ <a href="https://one.dash.cloudflare.com/" target="_blank">Cloudflare Zero Trust
                                Dashboard</a></li>
                        <li>ç™»å…¥æ‚¨çš„ Cloudflare å¸³è™Ÿ</li>
                        <li>åœ¨å·¦å´é¸å–®æ‰¾åˆ° <strong>Networks â†’ Connectors</strong> (æˆ– Tunnels)</li>
                        <li>é»æ“Š <strong>Create a tunnel</strong></li>
                        <li>é¸æ“‡ <strong>Cloudflared</strong> é¡å‹ï¼Œç‚º Tunnel å–å€‹åå­—</li>
                        <li>åœ¨ã€ŒInstall and run a connectorã€æ­¥é©Ÿä¸­ï¼Œè¤‡è£½é‚£æ®µ <code>eyJ...</code> Token</li>
                        <li>åœ¨ã€ŒRoute tunnelã€æ­¥é©Ÿä¸­ï¼Œè¨­å®šæ‚¨çš„ç¶²åŸŸæŒ‡å‘ <code>http://localhost:æ‚¨çš„Port</code></li>
                        <li>âš ï¸ <strong>Path (è·¯å¾‘) è«‹ç•™ç©º</strong>ï¼Œé™¤éæ‚¨çŸ¥é“ç”¨é€”ï¼Œå¦å‰‡æœƒå°è‡´ 404 éŒ¯èª¤</li>
                    </ol>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="tunnel-token">Tunnel Token</label>
                <input class="form-input" type="password" id="tunnel-token" placeholder="eyJhIjoixxxxxxxxxxxxxxx..."
                    autocomplete="off">
                <span class="form-hint">å¾ Cloudflare Dashboard è¤‡è£½çš„ Token</span>
            </div>

            <div class="form-group">
                <label class="form-label" for="tunnel-port">æœ¬åœ°æœå‹™åŸ è™Ÿ (Port)</label>
                <input class="form-input" type="number" id="tunnel-port" value="80" min="1" max="65535">
                <span class="form-hint">æ‚¨çš„ç¶²é æœå‹™åœ¨æœ¬æ©Ÿä½¿ç”¨çš„ Portï¼ˆå¸¸è¦‹ï¼š80ã€3000ã€8080ï¼‰</span>
            </div>

            <div class="form-group">
                <label class="form-label" for="tunnel-url">å…¬é–‹ç¶²å€ï¼ˆé¸å¡«ï¼‰</label>
                <input class="form-input" type="text" id="tunnel-url" placeholder="https://your-domain.com">
                <span class="form-hint">è¨­å®šåœ¨ Cloudflare çš„å…¬é–‹ç¶²å€ï¼Œæ–¹ä¾¿å„€è¡¨æ¿é¡¯ç¤º</span>
            </div>

            <div class="form-group">
                <label class="form-label" for="tunnel-service-mode">åŸ·è¡Œæ¨¡å¼</label>
                <div class="mode-toggle">
                    <button class="mode-toggle-btn active" id="mode-temp" onclick="setRunMode(false)">
                        <span data-icon="zap"></span>
                        è‡¨æ™‚åŸ·è¡Œ
                    </button>
                    <button class="mode-toggle-btn" id="mode-service" onclick="setRunMode(true)">
                        <span data-icon="shield"></span>
                        å®‰è£ç‚ºç³»çµ±æœå‹™
                    </button>
                </div>
                <span class="form-hint" id="mode-hint">ç¨‹å¼é—œé–‰æ™‚ Tunnel ä¹Ÿæœƒåœæ­¢ã€‚é©åˆæ¸¬è©¦ä½¿ç”¨ã€‚</span>
            </div>

            <div class="wizard-actions">
                <button class="btn btn-secondary" onclick="goToStep(1)">
                    <span data-icon="arrowLeft"></span>
                    ä¸Šä¸€æ­¥
                </button>
                <button class="btn btn-primary" id="setup-btn" onclick="submitSetup()">
                    <span data-icon="zap"></span>
                    å•Ÿå‹• Tunnel
                </button>
            </div>
        </div>

        <!-- Step 3: Complete -->
        <div class="wizard-panel" id="step-3">
            <div class="wizard-panel-icon success" data-icon="check"></div>
            <h2 class="wizard-panel-title">è¨­å®šå®Œæˆï¼ğŸ‰</h2>
            <p class="wizard-panel-text">
                æ‚¨çš„ Cloudflare Tunnel å·²æˆåŠŸå•Ÿå‹•ã€‚<br>
                ç¶²ç«™ç¾åœ¨å¯ä»¥é€éæ‚¨åœ¨ Cloudflare è¨­å®šçš„ç¶²åŸŸè¨ªå•äº†ã€‚
            </p>
            <div class="wizard-actions" style="justify-content: center;">
                <button class="btn btn-primary" onclick="window.location.href='/tunnel/dashboard'">
                    <span data-icon="arrowRight"></span>
                    å‰å¾€å„€è¡¨æ¿
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let installAsService = false;

    function goToStep(step) {
        document.querySelectorAll('.wizard-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active', 'done'));

        document.getElementById(`step-${step}`).classList.add('active');

        for (let i = 1; i <= 3; i++) {
            const stepEl = document.querySelector(`.wizard-step[data-step="${i}"]`);
            if (i < step) stepEl.classList.add('done');
            else if (i === step) stepEl.classList.add('active');
        }
    }

    async function downloadCloudflared() {
        const btn = document.getElementById('download-btn');
        const status = document.getElementById('download-status');
        const progress = document.getElementById('download-progress');

        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span> ä¸‹è¼‰ä¸­...`;
        status.innerHTML = `<div class="wizard-status-icon">${icon('info')}</div><span>æ­£åœ¨ä¸‹è¼‰ cloudflaredï¼Œè«‹ç¨å€™...</span>`;
        status.className = 'wizard-status info';
        progress.style.display = 'block';

        try {
            const resp = await fetch('/api/tunnel/install-binary', { method: 'POST' });
            const data = await resp.json();

            if (data.success) {
                status.innerHTML = `<div class="wizard-status-icon">${icon('check')}</div><span>ä¸‹è¼‰å®Œæˆï¼</span>`;
                status.className = 'wizard-status success';
                document.getElementById('download-bar').style.width = '100%';

                setTimeout(() => goToStep(2), 800);
            } else {
                status.innerHTML = `<div class="wizard-status-icon">${icon('alertCircle')}</div><span>${escapeHtml(data.message)}</span>`;
                status.className = 'wizard-status error';
                btn.disabled = false;
                btn.innerHTML = `${icon('download')} é‡è©¦ä¸‹è¼‰`;
            }
        } catch (e) {
            status.innerHTML = `<div class="wizard-status-icon">${icon('alertCircle')}</div><span>ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦</span>`;
            status.className = 'wizard-status error';
            btn.disabled = false;
            btn.innerHTML = `${icon('download')} é‡è©¦ä¸‹è¼‰`;
        }
    }

    function setRunMode(isService) {
        installAsService = isService;
        document.getElementById('mode-temp').classList.toggle('active', !isService);
        document.getElementById('mode-service').classList.toggle('active', isService);
        document.getElementById('mode-hint').textContent = isService
            ? 'å®‰è£ç‚ºç³»çµ±æœå‹™ï¼Œé‡é–‹æ©Ÿå¾Œè‡ªå‹•åŸ·è¡Œã€‚'
            : 'ç¨‹å¼é—œé–‰æ™‚ Tunnel ä¹Ÿæœƒåœæ­¢ã€‚é©åˆæ¸¬è©¦ä½¿ç”¨ã€‚';
    }

    function toggleTutorial() {
        const body = document.getElementById('tutorial-body');
        const chevron = document.querySelector('.tutorial-chevron');
        body.classList.toggle('open');
        chevron.classList.toggle('open');
    }

    async function submitSetup() {
        const token = document.getElementById('tunnel-token').value.trim();
        const port = document.getElementById('tunnel-port').value;
        const url = document.getElementById('tunnel-url').value.trim();

        if (!token) {
            showToast('è«‹è¼¸å…¥ Tunnel Token', 'error');
            return;
        }

        const btn = document.getElementById('setup-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span> å•Ÿå‹•ä¸­...`;

        try {
            const resp = await fetch('/api/tunnel/setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: token,
                    local_port: parseInt(port) || 80,
                    install_as_service: installAsService,
                    public_url: url,
                }),
            });
            const data = await resp.json();

            if (data.success) {
                showToast('Tunnel å•Ÿå‹•æˆåŠŸï¼', 'success');
                goToStep(3);
            } else {
                showToast(data.message || 'Token çœ‹èµ·ä¾†æœ‰èª¤ï¼Œè«‹é‡æ–°æª¢æŸ¥è¤‡è£½', 'error');
                btn.disabled = false;
                btn.innerHTML = `${icon('zap')} å•Ÿå‹• Tunnel`;
            }
        } catch (e) {
            showToast('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦', 'error');
            btn.disabled = false;
            btn.innerHTML = `${icon('zap')} å•Ÿå‹• Tunnel`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderIcons();

        // Check if binary already downloaded
        fetch('/api/tunnel/status').then(r => r.json()).then(data => {
            if (data.installed) {
                // Skip download step
                const status = document.getElementById('download-status');
                status.innerHTML = `<div class="wizard-status-icon">${icon('check')}</div><span>cloudflared å·²å®‰è£</span>`;
                status.className = 'wizard-status success';
                document.getElementById('download-btn').textContent = 'å·²å®‰è£ â€” ä¸‹ä¸€æ­¥';
                document.getElementById('download-btn').onclick = () => goToStep(2);
            }
        });
    });
</script>
{% endblock %}